<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Real-time Weather Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Kanit', sans-serif; transition: background 1s ease; overflow-x: hidden; }
    .bg-sunny { background: linear-gradient(to top, #87CEEB, #fdf497); }
    .bg-night { background: linear-gradient(to top, #0f2027, #203a43, #2c5364); }
    .bg-rain { background: linear-gradient(to top, #3a6073, #16222a); }
    .bg-cloudy { background: linear-gradient(to top, #d7d2cc, #304352); }
    .weather-card { background: rgba(255,255,255,0.8); backdrop-filter: blur(10px); border-radius: 1rem; padding: 1rem; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
    .forecast-scroll { display: flex; overflow-x: auto; gap: 1rem; padding: 0.5rem 0; }
    .forecast-item { min-width: 100px; text-align: center; background: rgba(255,255,255,0.7); border-radius: 0.75rem; padding: 0.5rem; flex-shrink: 0; }
    .stars, .clouds, .rain { position: fixed; width: 100%; height: 100%; pointer-events: none; z-index: 0; }
    .star { position: absolute; width:2px; height:2px; background: white; border-radius: 50%; animation: twinkle var(--tw,2s) infinite alternate; }
    @keyframes twinkle { from{opacity:0.2;} to{opacity:1;} }
    .cloud { position: absolute; background: #fff; border-radius: 50%; opacity: 0.8; animation: moveCloud var(--speed,40s) linear infinite; }
    @keyframes moveCloud { from{ transform: translateX(-200px) translateY(var(--y,0)); } to{ transform: translateX(100vw) translateY(var(--y,0)); } }
    .raindrop { position: absolute; width:2px; background:rgba(173,216,230,0.8); animation: fall var(--t,1.5s) linear infinite; }
    @keyframes fall { to{ transform: translateY(100vh); } }
  </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-start p-4 bg-sunny">
  <!-- Layers -->
  <div id="starsLayer" class="stars"></div>
  <div id="cloudsLayer" class="clouds">
    <div class="layer-1"></div>
    <div class="layer-2"></div>
    <div class="layer-3"></div>
  </div>
  <div id="rainLayer" class="rain"></div>
  <div id="rainDropsLayer" class="rain"></div>

  <div class="relative z-10 w-full max-w-4xl">
    <h1 class="text-3xl font-semibold mb-4 text-center">Weather Dashboard</h1>
    <!-- Current Weather -->
    <div id="current-weather" class="weather-card mb-6 text-center"></div>
    <!-- Daily Forecast -->
    <h2 class="text-xl font-semibold mb-2">7-Day Forecast</h2>
    <div id="daily-forecast" class="forecast-scroll mb-6"></div>
    <!-- Hourly Forecast -->
    <h2 class="text-xl font-semibold mb-2">Next Hours</h2>
    <div id="hourly-forecast" class="forecast-scroll"></div>
  </div>

  <script>
    const API_KEY = 'ccffd32214c3b336e740cd6b4c9cf5d0';
    const cloudsLayer = document.getElementById('cloudsLayer');
    const rainLayer = document.getElementById('rainLayer');
    const rainDropsLayer = document.getElementById('rainDropsLayer');
    const starsLayer = document.getElementById('starsLayer');

    /* ========== UTILITIES ========== */
    function getWeatherIcon(id){
      if(id >=200 && id<300) return '⛈️';
      if(id >=300 && id<400) return '🌧️';
      if(id >=500 && id<600) return '🌧️';
      if(id >=600 && id<700) return '❄️';
      if(id >=700 && id<800) return '🌫️';
      if(id === 800) return '☀️';
      if(id > 800 && id < 900) return '☁️';
      return '❓';
    }
    function classifyWeather(id){
      if(id >=200 && id<600) return 'rain';
      if(id === 800) return 'sunny';
      if(id > 800 && id < 900) return 'cloudy';
      if(id >=700 && id<800) return 'cloudy';
      return 'sunny';
    }
    function isNightBySys(sys){
      const now = Math.floor(Date.now()/1000);
      return !(now > sys.sunrise && now < sys.sunset);
    }
    function clearLayers(){
      cloudsLayer.style.display = 'none';
      rainLayer.style.display = 'none';
      rainDropsLayer.style.display = 'none';
      starsLayer.style.display = 'none';
      [...cloudsLayer.querySelectorAll('.cloud')].forEach(n=>n.remove());
      [...rainDropsLayer.querySelectorAll('.raindrop')].forEach(n=>n.remove());
      [...starsLayer.querySelectorAll('.star')].forEach(n=>n.remove());
    }
    function setBodyTheme(theme, night=false){
      document.body.classList.remove('bg-sunny','bg-rain','bg-cloudy','bg-night');
      if(night) document.body.classList.add('bg-night');
      else{
        if(theme==='rain') document.body.classList.add('bg-rain');
        else if(theme==='cloudy') document.body.classList.add('bg-cloudy');
        else document.body.classList.add('bg-sunny');
      }
    }
    function spawnClouds(){
      cloudsLayer.style.display = 'block';
      const layers = [cloudsLayer.querySelector('.layer-1'), cloudsLayer.querySelector('.layer-2'), cloudsLayer.querySelector('.layer-3')];
      const counts = [5,6,7];
      layers.forEach((layer, idx)=>{
        for(let i=0;i<counts[idx];i++){
          const c = document.createElement('div');
          c.className = 'cloud';
          const w = 180 + Math.random()*220;
          c.style.setProperty('--w', w+'px');
          c.style.setProperty('--h', (60 + Math.random()*40)+'px');
          c.style.top = (Math.random()*85)+'vh';
          c.style.left = (-30 + Math.random()*120)+'vw';
          c.style.setProperty('--y', (Math.random()*10-5)+'px');
          const base = idx===0?90:(idx===1?70:55);
          c.style.setProperty('--speed', (base + Math.random()*20)+'s');
          c.style.width = w+'px';
          c.style.height = (60 + Math.random()*40)+'px';
          layer.appendChild(c);
        }
      });
    }
    function spawnRain(density=110){
      rainLayer.style.display = 'block';
      rainDropsLayer.style.display = 'block';
      const w = window.innerWidth;
      for(let i=0;i<density;i++){
        const d = document.createElement('div');
        d.className = 'raindrop';
        d.style.left = Math.random()*w + 'px';
        d.style.top = (-100 - Math.random()*400) + 'px';
        d.style.height = (40 + Math.random()*80)+'px';
        d.style.opacity = (0.3 + Math.random()*0.7).toFixed(2);
        d.style.setProperty('--t', (0.9 + Math.random()*0.9) + 's');
        rainDropsLayer.appendChild(d);
      }
    }
    function spawnStars(count=140){
      starsLayer.style.display = 'block';
      const w = window.innerWidth;
      const h = window.innerHeight;
      for(let i=0;i<count;i++){
        const s = document.createElement('div');
        s.className = 'star';
        s.style.left = Math.random()*w+'px';
        s.style.top = Math.random()*h+'px';
        s.style.opacity = (0.4+Math.random()*0.6).toFixed(2);
        s.style.setProperty('--tw', (1.6+Math.random()*2.2)+'s');
        starsLayer.appendChild(s);
      }
    }
    function updateFX(theme, night=false){
      clearLayers();
      if(night){
        setBodyTheme(theme, true);
        spawnStars();
        if(theme==='cloudy') spawnClouds();
        if(theme==='rain') spawnRain();
        return;
      }
      setBodyTheme(theme, false);
      if(theme==='sunny') spawnClouds();
      else if(theme==='cloudy') spawnClouds();
      else if(theme==='rain'){ spawnClouds(); spawnRain(); }
    }

    /* ========== FETCH WEATHER ========== */
    async function fetchWeatherData(lat, lon){
      const forecastUrl = `https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&appid=${API_KEY}&units=metric`;
      const currentUrl = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${API_KEY}&units=metric`;
      try{
        const [forecastResponse, currentResponse] = await Promise.all([ fetch(forecastUrl), fetch(currentUrl) ]);
        if(!forecastResponse.ok || !currentResponse.ok){
          throw new Error(`HTTP error!`);
        }
        const forecastData = await forecastResponse.json();
        const currentData = await currentResponse.json();

        displayCurrentWeather(currentData, forecastData);
        displayHourlyForecast(forecastData.list);
        displayDailyForecast(forecastData.list);

        const wId = currentData.weather?.[0]?.id ?? 800;
        const night = isNightBySys(currentData.sys);
        const theme = classifyWeather(wId);
        updateFX(theme, night);

        // update ชื่อเมืองจริง
        document.querySelector("h1").textContent = `${currentData.name}, ${currentData.sys.country}`;
      }catch(err){
        console.error('Failed to fetch weather data:', err);
      }
    }

    /* ========== RENDER SECTIONS ========== */
    function displayCurrentWeather(data, forecastData){
      const el = document.getElementById('current-weather');
      const temp = Math.round(data.main.temp);
      const cond = data.weather[0].description;
      const icon = getWeatherIcon(data.weather[0].id);
      const hum = data.main.humidity;
      const wind = data.wind.speed;
      const forecastDesc = forecastData.list[0].weather[0].description;
      el.innerHTML = `
        <div class="flex flex-col items-center">
          <div class="text-6xl mb-2">${icon}</div>
          <div class="text-4xl font-bold">${temp}°C</div>
          <div class="capitalize">${cond}</div>
          <div class="mt-2 text-sm text-gray-700">Humidity: ${hum}% | Wind: ${wind} m/s</div>
          <div class="mt-1 text-sm text-gray-500">Next: ${forecastDesc}</div>
        </div>`;
    }

    function displayDailyForecast(list){
      const el = document.getElementById('daily-forecast');
      el.innerHTML = '';
      const days = {};
      list.forEach(item=>{
        const d = new Date(item.dt*1000);
        const day = d.toLocaleDateString('en-US',{weekday:'short'});
        if(!days[day]){
          days[day] = item;
        }
      });
      Object.entries(days).slice(0,7).forEach(([day, item])=>{
        const temp = Math.round(item.main.temp);
        const icon = getWeatherIcon(item.weather[0].id);
        el.innerHTML += `<div class="forecast-item"><div>${day}</div><div class="text-2xl">${icon}</div><div>${temp}°C</div></div>`;
      });
    }

    function displayHourlyForecast(list){
      const el = document.getElementById('hourly-forecast');
      el.innerHTML = '';
      list.slice(0,12).forEach(item=>{
        const d = new Date(item.dt*1000);
        const time = d.toLocaleTimeString('en-US',{hour:'numeric'});
        const temp = Math.round(item.main.temp);
        const icon = getWeatherIcon(item.weather[0].id);
        el.innerHTML += `<div class="forecast-item"><div>${time}</div><div class="text-2xl">${icon}</div><div>${temp}°C</div></div>`;
      });
    }

    /* ========== GEOLOCATION INIT ========== */
    function getUserLocation(){
      if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(
          (pos)=>{ fetchWeatherData(pos.coords.latitude, pos.coords.longitude); },
          (err)=>{ console.warn("Geolocation Error:", err); fetchWeatherData(13.7563, 100.5018); }
        );
      }else{
        console.warn("Geolocation not supported, fallback to Bangkok.");
        fetchWeatherData(13.7563, 100.5018);
      }
    }

    getUserLocation();
  </script>
</body>
</html>
